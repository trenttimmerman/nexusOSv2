import React from 'react';
import { ShoppingBag, Search, User, Menu, Hexagon, X } from 'lucide-react';
import { NavLink } from '../types';

// Header customization data structure
export interface HeaderData {
  // === CORE VISIBILITY TOGGLES ===
  showSearch?: boolean;
  showAccount?: boolean;
  showCart?: boolean;
  showCTA?: boolean;
  showMenu?: boolean;
  showTagline?: boolean;
  showLogoBadge?: boolean;
  showIndicatorDot?: boolean;
  
  // === 2026 FEATURE TOGGLES ===
  showMobileMenu?: boolean;
  showAnnouncementBar?: boolean;
  showUtilityBar?: boolean;
  showCommandPalette?: boolean; // Cmd+K search
  enableSmartScroll?: boolean; // Hide on scroll down, show on scroll up
  enableMegaMenu?: boolean;
  megaMenuStyle?: 'traditional' | 'bento'; // List-based vs Card-based
  enableSpotlightBorders?: boolean;
  enableGlassmorphism?: boolean;
  
  // === NAVIGATION STYLES ===
  navActiveStyle?: 'none' | 'dot' | 'underline' | 'capsule' | 'glow' | 'brutalist' | 'minimal' | 'overline' | 'double' | 'bracket' | 'highlight' | 'skewed';
  
  // === CORE COLORS ===
  backgroundColor?: string;
  borderColor?: string;
  textColor?: string;
  textHoverColor?: string;
  accentColor?: string;
  cartBadgeColor?: string;
  cartBadgeTextColor?: string;
  taglineColor?: string;
  
  // === SIZING ===
  iconSize?: number;
  iconHoverBackgroundColor?: string;
  borderWidth?: string;
  iconBorderWidth?: string;
  tickerBorderWidth?: string;
  gridDividerWidth?: string;
  
  // === CTA/BUTTON ===
  ctaBackgroundColor?: string;
  ctaHoverColor?: string;
  ctaTextColor?: string;
  ctaText?: string;
  
  // === ANNOUNCEMENT BAR (2026) ===
  announcementText?: string;
  announcementBackgroundColor?: string;
  announcementTextColor?: string;
  announcementDismissible?: boolean;
  announcementMarquee?: boolean;
  
  // === UTILITY BAR (2026) ===
  utilityBarBackgroundColor?: string;
  utilityBarTextColor?: string;
  utilityBarLinks?: Array<{ label: string; href: string }>;
  showCurrencySelector?: boolean;
  showLanguageSelector?: boolean;
  
  // === TICKER ===
  tickerBackgroundColor?: string;
  tickerTextColor?: string;
  tickerBorderColor?: string;
  tickerText?: string;
  
  // === TAGLINE ===
  taglineText?: string;
  
  // === SEARCH FEATURES ===
  showKeyboardShortcut?: boolean;
  searchPlaceholder?: string;
  searchBackgroundColor?: string;
  searchFocusBackgroundColor?: string;
  searchFocusBorderColor?: string;
  searchInputTextColor?: string;
  searchPlaceholderColor?: string;
  searchBorderColor?: string;
  
  // === MOBILE MENU (2026) ===
  mobileMenuBackgroundColor?: string;
  mobileMenuTextColor?: string;
  mobileMenuOverlayOpacity?: number; // 0-100
  mobileMenuPosition?: 'left' | 'right' | 'top' | 'bottom';
  mobileMenuWidth?: string; // e.g., '300px', '80%'
  
  // === MEGA MENU (2026) ===
  megaMenuBackgroundColor?: string;
  megaMenuBorderColor?: string;
  megaMenuColumns?: number; // 2-6 columns
  megaMenuMaxHeight?: string;
  
  // === GLASSMORPHISM (2026) ===
  blurIntensity?: string;
  glassBackgroundOpacity?: number; // 0-100
  glassBorderOpacity?: number; // 0-100
  
  // === SPOTLIGHT BORDERS (2026) ===
  spotlightColor?: string;
  spotlightIntensity?: number; // 0-100
  
  // === SMART SCROLL (2026) ===
  smartScrollThreshold?: number; // Pixels to scroll before hiding
  smartScrollDuration?: number; // Animation duration in ms
  
  // === LEGACY FEATURES ===
  expandedMenuEnabled?: boolean;
  checkoutButtonText?: string;
  
  // === INTERACTIVE EFFECTS ===
  particleCount?: number;
  particleColor?: string;
  accentColorSecondary?: string;
  terminalPromptColor?: string;
  scanlineColor?: string;
  buttonHoverBackgroundColor?: string;
  glowIntensity?: number; // 0-100 for opacity percentages
  
  // === LAYOUT ===
  sticky?: boolean;
  maxWidth?: 'sm' | 'md' | 'lg' | 'xl' | '2xl' | '3xl' | '4xl' | '5xl' | '6xl' | '7xl' | 'full';
  paddingX?: string;
  paddingY?: string;
}

interface HeaderProps {
  storeName: string;
  logoUrl?: string;
  logoHeight?: number;
  links: NavLink[];
  cartCount: number;
  onOpenCart?: () => void;
  onLogoClick?: () => void;
  onLinkClick?: (href: string) => void;
  onSearchClick?: () => void;
  isSearchOpen?: boolean;
  onSearchClose?: () => void;
  onSearchSubmit?: (query: string) => void;
  primaryColor?: string;
  secondaryColor?: string;
  data?: HeaderData; // Per-header customization
}

// Inline Search Input Component
const InlineSearch: React.FC<{
  isOpen: boolean;
  onClose: () => void;
  onSubmit?: (query: string) => void;
  className?: string;
  inputClassName?: string;
  iconColor?: string;
  placeholder?: string;
  style?: React.CSSProperties;
  inputStyle?: React.CSSProperties;
}> = ({ isOpen, onClose, onSubmit, className = '', inputClassName = '', iconColor, placeholder = 'Search...', style = {}, inputStyle = {} }) => {
  const [query, setQuery] = React.useState('');
  const inputRef = React.useRef<HTMLInputElement>(null);

  React.useEffect(() => {
    if (isOpen && inputRef.current) {
      setTimeout(() => inputRef.current?.focus(), 50);
    }
    if (!isOpen) setQuery('');
  }, [isOpen]);

  React.useEffect(() => {
    const handleEscape = (e: KeyboardEvent) => {
      if (e.key === 'Escape' && isOpen) onClose();
    };
    document.addEventListener('keydown', handleEscape);
    return () => document.removeEventListener('keydown', handleEscape);
  }, [isOpen, onClose]);

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    if (query.trim()) {
      onSubmit?.(query.trim());
      onClose();
    }
  };

  return (
    <div className={`flex items-center overflow-hidden transition-all duration-300 ease-out ${className}`}
      style={{ width: isOpen ? '200px' : '0px', opacity: isOpen ? 1 : 0, ...style }}
    >
      <form onSubmit={handleSubmit} className="flex items-center w-full">
        <input
          ref={inputRef}
          type="text"
          value={query}
          onChange={(e) => setQuery(e.target.value)}
          placeholder={placeholder}
          className={`w-full text-sm outline-none ${inputClassName}`}
          style={inputStyle}
        />
        <button type="button" onClick={onClose} className="p-1 hover:opacity-70 transition-opacity flex-shrink-0">
          <X size={14} style={{ color: iconColor }} />
        </button>
      </form>
    </div>
  );
};

// Default values for HeaderCanvas (2026 Edition)
const CANVAS_DEFAULTS: HeaderData = {
  // Core features
  showSearch: true,
  showAccount: true,
  showCart: true,
  
  // 2026 features enabled by default
  showMobileMenu: true,
  showAnnouncementBar: false,
  showUtilityBar: false,
  showCommandPalette: false,
  enableSmartScroll: false,
  enableMegaMenu: false,
  megaMenuStyle: 'traditional',
  enableSpotlightBorders: false,
  enableGlassmorphism: false,
  
  // Colors
  backgroundColor: '#ffffff',
  borderColor: '#f3f4f6',
  textColor: '#6b7280',
  textHoverColor: '#000000',
  cartBadgeColor: '#000000',
  cartBadgeTextColor: '#ffffff',
  accentColor: '#3b82f6',
  
  // Sizing
  iconSize: 20,
  iconHoverBackgroundColor: 'transparent',
  borderWidth: '1px',
  
  // Layout
  sticky: true,
  maxWidth: '7xl',
  paddingX: '24px',
  paddingY: '16px',
  
  // Navigation
  navActiveStyle: 'dot',
  
  // Announcement bar
  announcementText: 'Free shipping on orders over $100',
  announcementBackgroundColor: '#000000',
  announcementTextColor: '#ffffff',
  announcementDismissible: true,
  announcementMarquee: false,
  
  // Utility bar
  utilityBarBackgroundColor: '#f9fafb',
  utilityBarTextColor: '#6b7280',
  showCurrencySelector: true,
  showLanguageSelector: true,
  
  // Mobile menu
  mobileMenuBackgroundColor: '#ffffff',
  mobileMenuTextColor: '#000000',
  mobileMenuOverlayOpacity: 50,
  mobileMenuPosition: 'left',
  mobileMenuWidth: '320px',
  
  // Mega menu
  megaMenuBackgroundColor: '#ffffff',
  megaMenuBorderColor: '#e5e7eb',
  megaMenuColumns: 4,
  megaMenuMaxHeight: '500px',
  
  // Glassmorphism
  blurIntensity: 'xl',
  glassBackgroundOpacity: 60,
  glassBorderOpacity: 20,
  
  // Spotlight borders
  spotlightColor: '#3b82f6',
  spotlightIntensity: 50,
  
  // Smart scroll
  smartScrollThreshold: 100,
  smartScrollDuration: 300,
  
  // Search
  searchPlaceholder: 'Search products...',
  searchBackgroundColor: '#f9fafb',
  searchBorderColor: '#e5e7eb',
  searchInputTextColor: '#000000',
};

// Global base defaults for all headers
export const DEFAULTS: HeaderData = {
  showSearch: true,
  showAccount: true,
  showCart: true,
  backgroundColor: '#ffffff',
  borderColor: '#f3f4f6',
  textColor: '#6b7280',
  textHoverColor: '#000000',
  cartBadgeColor: '#000000',
  cartBadgeTextColor: '#ffffff',
  iconSize: 18,
  sticky: true,
  maxWidth: '7xl',
  navActiveStyle: 'dot',
};

// Reusable Logo component
const Logo: React.FC<{
  storeName: string;
  logoUrl?: string;
  logoHeight?: number;
  className?: string;
  onClick?: () => void;
}> = ({ storeName, logoUrl, logoHeight = 32, className, onClick }) => {
  const content = logoUrl ? (
    <img src={logoUrl} alt={storeName} style={{ height: `${logoHeight}px`, width: 'auto' }} className="object-contain" />
  ) : (
    <span className={className}>{storeName}</span>
  );

  if (onClick) {
    return <button onClick={onClick} className="cursor-pointer">{content}</button>;
  }
  return <>{content}</>;
};

const NavItem: React.FC<{
  link: NavLink;
  className?: string;
  style?: React.CSSProperties;
  hoverColor?: string;
  activeColor?: string;
  activeStyle?: 'none' | 'dot' | 'underline' | 'capsule' | 'glow' | 'brutalist' | 'minimal' | 'overline' | 'double' | 'bracket' | 'highlight' | 'skewed';
  children?: React.ReactNode;
  onClick?: (href: string) => void;
  [key: string]: any;
}> = ({ link, className, style, hoverColor, activeColor, activeStyle = 'dot', children, onClick, ...rest }) => {
  const [isHovered, setIsHovered] = React.useState(false);
  
  const handleClick = (e: React.MouseEvent) => {
    if (onClick) {
      e.preventDefault();
      onClick(link.href);
    }
  };

  const isActive = link.active;
  const currentColor = isActive && activeColor ? activeColor : (isHovered && hoverColor ? hoverColor : style?.color);

  // Helper to render Different Styles
  const renderIndicator = () => {
    if (!isActive) return null;

    switch (activeStyle) {
      case 'dot':
        return (
          <span 
            className="absolute -bottom-2 left-1/2 -translate-x-1/2 w-1.5 h-1.5 rounded-full animate-pulse"
            style={{ backgroundColor: activeColor || hoverColor || style?.color }}
          />
        );
      case 'underline':
        return (
          <span 
            className="absolute -bottom-1 left-0 right-0 h-0.5 transform scale-x-100 transition-transform duration-300 origin-left"
            style={{ backgroundColor: activeColor || hoverColor || style?.color }}
          />
        );
      case 'overline':
        return (
          <span 
            className="absolute -top-1 left-0 right-0 h-0.5 transform scale-x-100 transition-transform duration-300 origin-left"
            style={{ backgroundColor: activeColor || hoverColor || style?.color }}
          />
        );
      case 'double':
        return (
          <>
            <span 
              className="absolute -top-1 left-0 right-0 h-0.5 transform scale-x-100 transition-transform duration-300"
              style={{ backgroundColor: activeColor || hoverColor || style?.color }}
            />
            <span 
              className="absolute -bottom-1 left-0 right-0 h-0.5 transform scale-x-100 transition-transform duration-300"
              style={{ backgroundColor: activeColor || hoverColor || style?.color }}
            />
          </>
        );
      case 'bracket':
        return (
          <>
            <span 
              className="absolute top-0 -left-3 bottom-0 w-1.5 border-l-2 border-t-2 border-b-2"
              style={{ borderColor: activeColor || hoverColor || style?.color }}
            />
            <span 
              className="absolute top-0 -right-3 bottom-0 w-1.5 border-r-2 border-t-2 border-b-2"
              style={{ borderColor: activeColor || hoverColor || style?.color }}
            />
          </>
        );
      case 'brutalist':
        return (
          <span 
            className="absolute -inset-x-2 -inset-y-1 border-2 z-[-1]"
            style={{ borderColor: activeColor || hoverColor || style?.color, backgroundColor: `${activeColor || hoverColor || style?.color}10` }}
          />
        );
      default:
        return null;
    }
  };

  const getActiveClasses = () => {
    if (!isActive) return '';
    
    switch (activeStyle) {
      case 'capsule':
        return 'px-4 py-1.5 rounded-full bg-opacity-10';
      case 'highlight':
        return 'px-1 py-0.5 rounded-sm';
      case 'skewed':
        return 'px-5 py-1.5 -skew-x-12';
      case 'glow':
        return '';
      case 'minimal':
        return 'font-bold scale-105';
      default:
        return '';
    }
  };

  const activeStyles: React.CSSProperties = {};
  if (isActive) {
    if (activeStyle === 'capsule') {
      activeStyles.backgroundColor = `${activeColor || hoverColor || style?.color}15`;
    }
    if (activeStyle === 'highlight') {
      activeStyles.backgroundColor = `${activeColor || hoverColor || style?.color}40`;
      activeStyles.transform = 'rotate(-1deg)';
      activeStyles.borderRadius = '2px';
    }
    if (activeStyle === 'skewed') {
      activeStyles.backgroundColor = `${activeColor || hoverColor || style?.color}20`;
      activeStyles.borderRight = `2px solid ${activeColor || hoverColor || style?.color}`;
    }
    if (activeStyle === 'glow') {
      activeStyles.textShadow = `0 0 15px ${activeColor || hoverColor || style?.color}80`;
      activeStyles.filter = `drop-shadow(0 0 8px ${activeColor || hoverColor || style?.color}40)`;
    }
  }

  return (
    <a
      href={link.href}
      onClick={handleClick}
      className={`relative group flex items-center justify-center transition-all duration-300 ${className || ''} ${getActiveClasses()}`}
      {...rest}
      style={{
        ...style,
        ...activeStyles,
        color: currentColor,
      }}
      onMouseEnter={() => setIsHovered(true)}
      onMouseLeave={() => setIsHovered(false)}
    >
      <span className="relative">
        {children || link.label}
        {renderIndicator()}
      </span>
    </a>
  );
};

// 1. HeaderCanvas - "Classic Clean" (Minimalist, Clean, Airy)
export const HeaderCanvas: React.FC<HeaderProps> = ({
  storeName,
  logoUrl,
  logoHeight,
  links,
  cartCount,
  onOpenCart,
  onLogoClick,
  onLinkClick,
  onSearchClick,
  isSearchOpen,
  onSearchClose,
  onSearchSubmit,
  data = {},
}) => {
  // Merge defaults with customization
  const settings = { ...CANVAS_DEFAULTS, ...data };
  
  const maxWidthClass = settings.maxWidth === 'full' ? 'max-w-full' : `max-w-${settings.maxWidth}`;

  return (
    <header
      className={`w-full ${settings.sticky ? 'sticky top-0' : ''} z-[100]`}
      style={{
        backgroundColor: settings.backgroundColor,
        borderBottom: `${settings.borderWidth} solid ${settings.borderColor}`,
      }}
    >
      <div
        className={`${maxWidthClass} mx-auto flex items-center justify-between`}
        style={{
          paddingLeft: settings.paddingX,
          paddingRight: settings.paddingX,
          paddingTop: settings.paddingY,
          paddingBottom: settings.paddingY,
          minHeight: '5rem',
        }}
      >
        {/* Left: Logo + Navigation */}
        <div className="flex items-center gap-8">
          <Logo
            storeName={storeName}
            logoUrl={logoUrl}
            logoHeight={logoHeight}
            className="text-2xl font-bold tracking-tight"
            onClick={onLogoClick}
          />
          <nav className="hidden md:flex gap-6">
            {(links || []).map((link) => (
              <NavItem
                key={link.href}
                link={link}
                onClick={onLinkClick}
                className="text-sm font-medium"
                style={{ color: settings.textColor }}
                hoverColor={settings.textHoverColor}
                activeColor={settings.textHoverColor}
                activeStyle={settings.navActiveStyle}
              />
            ))}
          </nav>
        </div>

        {/* Right: Icons */}
        <div className="flex items-center gap-2">
          {settings.showSearch && (
            <div className="flex items-center">
              <InlineSearch
                isOpen={isSearchOpen || false}
                onClose={onSearchClose || (() => {})}
                onSubmit={onSearchSubmit}
                placeholder={settings.searchPlaceholder}
                inputClassName="border-b px-2 py-1"
                inputStyle={{
                  backgroundColor: settings.searchBackgroundColor,
                  borderColor: settings.searchBorderColor,
                  color: settings.searchInputTextColor,
                }}
                iconColor={settings.textColor}
              />
              {!isSearchOpen && (
                <button
                  onClick={onSearchClick}
                  className="p-2 rounded-full transition-colors"
                  style={{ 
                    color: settings.textColor,
                    backgroundColor: 'transparent'
                  }}
                  onMouseEnter={(e) => {
                    e.currentTarget.style.color = settings.textHoverColor!;
                    e.currentTarget.style.backgroundColor = settings.iconHoverBackgroundColor!;
                  }}
                  onMouseLeave={(e) => {
                    e.currentTarget.style.color = settings.textColor!;
                    e.currentTarget.style.backgroundColor = 'transparent';
                  }}
                >
                  <Search size={settings.iconSize} />
                </button>
              )}
            </div>
          )}
          {settings.showAccount && (
            <button
              className="p-2 rounded-full transition-colors"
              style={{ 
                color: settings.textColor,
                backgroundColor: 'transparent'
              }}
              onMouseEnter={(e) => {
                e.currentTarget.style.color = settings.textHoverColor!;
                e.currentTarget.style.backgroundColor = settings.iconHoverBackgroundColor!;
              }}
              onMouseLeave={(e) => {
                e.currentTarget.style.color = settings.textColor!;
                e.currentTarget.style.backgroundColor = 'transparent';
              }}
            >
              <User size={settings.iconSize} />
            </button>
          )}
          {settings.showCart && (
            <button
              onClick={onOpenCart}
              className="relative p-2 rounded-full transition-colors"
              style={{ 
                color: settings.textColor,
                backgroundColor: 'transparent'
              }}
              onMouseEnter={(e) => {
                e.currentTarget.style.color = settings.textHoverColor!;
                e.currentTarget.style.backgroundColor = settings.iconHoverBackgroundColor!;
              }}
              onMouseLeave={(e) => {
                e.currentTarget.style.color = settings.textColor!;
                e.currentTarget.style.backgroundColor = 'transparent';
              }}
            >
              <ShoppingBag size={settings.iconSize} />
              {cartCount > 0 && (
                <span
                  className="absolute top-0 right-0 w-4 h-4 text-[10px] flex items-center justify-center rounded-full"
                  style={{
                    backgroundColor: settings.cartBadgeColor,
                    color: settings.cartBadgeTextColor,
                  }}
                >
                  {cartCount}
                </span>
              )}
            </button>
          )}
        </div>
      </div>
    </header>
  );
};

export const HEADER_COMPONENTS: Record<string, React.FC<HeaderProps>> = {
  canvas: HeaderCanvas,
};

export const HEADER_OPTIONS = [
  { id: 'canvas', name: 'Classic Clean', description: 'Simple and elegant', date: '2024-01-01', popularity: 95, recommended: true },
];

export const HEADER_FIELDS: Record<string, string[]> = {
  canvas: [
    'showSearch', 'showAccount', 'showCart',
    'backgroundColor', 'borderColor', 'textColor', 'textHoverColor',
    'cartBadgeColor', 'cartBadgeTextColor',
    'iconSize', 'iconHoverBackgroundColor', 'borderWidth',
    'sticky', 'maxWidth', 'paddingX', 'paddingY', 'navActiveStyle',
    'searchPlaceholder', 'searchBackgroundColor', 'searchBorderColor', 'searchInputTextColor'
  ],
};
